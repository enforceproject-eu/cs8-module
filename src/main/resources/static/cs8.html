<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link rel="icon" sizes="192x192" href="https://join-enforce.eu/storage/2025/03/favicon-192.png">
<title>ENFORCE CS8 Data</title>

<script src="https://unpkg.com/rxjs@^7/dist/bundles/rxjs.umd.min.js"></script>

<link href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css"
	rel="stylesheet" />
<script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
<link rel="stylesheet" href="https://leaflet.github.io/Leaflet.markercluster/dist/MarkerCluster.css" />
<link rel="stylesheet" href="https://leaflet.github.io/Leaflet.markercluster/dist/MarkerCluster.Default.css" />
<script src="https://leaflet.github.io/Leaflet.markercluster/dist//leaflet.markercluster-src.js"></script>


<style>
html, body {
	height: 100%;
	margin: 0;
}

.leaflet-container {
	height: 1000px;
	width: 1000px;
	max-width: 100%;
	max-height: 100%;
}

.leaflet-popup-content {
	height: 100%;
	width: 300px !important;
}

img.half {
	height: 50%;
	width: 50%;
}

.header {
	background-image:
		url("https://join-enforce.eu/wp-content/uploads/2025/03/header-bg.png");
	background-repeat: repeat-x;
}
</style>

<script>

        const MAX_FEATURE_COUNT = 1000;
        const MAP_CRS = 'EPSG:4326';
        const GEOSERVER_URL = '/cs8_pfos_data';
        
        class Map {

            map;
            featureLayer;

            constructor() {
                this.initMap();
            }

            initMap() {

                this.map = L.map('map', {
                    center: [51.22, 4.33],
                    zoom: 8,
                });

                const tiles = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                    attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
                }).addTo(this.map);

                tiles.addTo(this.map);

                this.fetchFeatures();

                const subject = new rxjs.Subject();
                subject.asObservable()
                    .pipe(
                        rxjs.sampleTime(250)
                    )
                    .subscribe(_ => this.fetchFeatures());

                for (const eventName of ['resize', 'viewreset', 'zoomend', 'moveend']) {
                    this.map.on(eventName, event => {
                        subject.next(event);
                    });
                }

            }

            async fetchFeatures() {

                const params = new URLSearchParams({
                    limit: `${MAX_FEATURE_COUNT}`,  // note: maxFeatures with WFS 1.1 and earlier
                    outputFormat: 'application/json',
                });

                const response = await fetch(`${GEOSERVER_URL}?${params}`);
                const features = await response.json();      

        		var markers = L.markerClusterGroup();          

                if (!!this.featureLayer) {
                    this.map.removeLayer(this.featureLayer);
                }
                
                this.featureLayer = L.geoJSON(features, {
                    pointToLayer: (feature, latlng) => L.circleMarker(latlng, {
                        radius: 3,
                        color: "blue",
                        fillColor: "red",
                        fillOpacity: 1,
                    }),
                    onEachFeature: (feature, layer) => {
                        var title= "feature"
                		var marker = L.marker(new L.LatLng(feature.geometry.coordinates[1], feature.geometry.coordinates[0]), { title: title });
                        var content = "<h1>Compartment: " + feature.properties.compartment + "</h1>";
                        var tableInner = "";
                        tableInner = tableInner + "<tr>";
                        tableInner = tableInner + "<td>pfba</td>";
                        tableInner = tableInner + "<td>" + feature.properties.pfba + "</td>";
                        tableInner = tableInner + "</tr>";
                        
                        tableInner = tableInner + "<tr>";
                        tableInner = tableInner + "<td>biomass</td>";
                        tableInner = tableInner + "<td>" + feature.properties.biomass + "</td>";
                        tableInner = tableInner + "</tr>";
                        
                        tableInner = tableInner + "<tr>";
                        tableInner = tableInner + "<td>total above</td>";
                        tableInner = tableInner + "<td>" + feature.properties["total abov"] + "</td>";
                        tableInner = tableInner + "</tr>";
                        var customPopup = content
                        +  "<h2>Properties</h2>"
                        +  "<table>"
                        +  "<tr>"
                        +  "<th>Name</th>"
                        +  "<th>Value</th>"
                        +  "</tr>"
                        + tableInner
                        +  "</table>";
					    layer.bindPopup(customPopup);
					    marker.bindPopup(customPopup);
            			markers.addLayer(marker);
                    }
                
                });
                markers.addTo(this.map);

            }

        }

        document.addEventListener("DOMContentLoaded", () => new Map());

    </script>

</head>
<body>
	<header class="header-wrapper">
		<div class="header"
			style="height: 102px; overflow: visible; top: 0px;"></div>
	</header>
	<h1>ENFORCE CS8 Data</h1>
	<div id="map"></div>
	<form method="post" enctype="application/enforce-cs5-data" action="./cs5_catchment_data">
      <div>
        <label for="file">Choose CS 5 data to upload</label>
        <input type="file" id="upload" name="upload" />
      </div>
      <div>
        <button>Submit</button>
      </div>
    </form>
</body>
</html>